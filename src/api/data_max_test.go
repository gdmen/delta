package api

import (
	_ "github.com/mattn/go-sqlite3"
	"io/ioutil"
	"net/http"
	"net/http/httptest"
	"strings"
	"testing"
)

func TestGetMaxesBasic(t *testing.T) {
	ResetTestApi()
	PopulateTestApi()
	r := TestApi.GetRouter()

	resp := httptest.NewRecorder()

	req, _ := http.NewRequest("GET", `/api/v1/data/maxes?fields=[{"name":"Flat Barbell Bench Press"},{"name":"Barbell Back Squat"},{"name":"Conventional Barbell Deadlift"}]&increment=2`, nil)

	r.ServeHTTP(resp, req)

	if resp.Code != http.StatusOK {
		t.Fatalf("Expected status code %d, got %d. . .\n%+v", http.StatusOK, resp.Code, resp)
	}

	body, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		t.Fatal(err)
	}
	if strings.TrimSpace(string(body)) != `{"data":[{"name":"2014-08-09","y":314},{"name":"2014-08-16","y":548},{"name":"2014-08-23","y":545.7316444959579},{"name":"2014-08-30","y":543.4726784749317},{"name":"2014-09-06","y":541.2230630707072},{"name":"2014-09-13","y":538.98275957795},{"name":"2014-09-20","y":536.7517294515404},{"name":"2014-09-27","y":534.5299343059099},{"name":"2014-10-04","y":532.3173359143807},{"name":"2014-10-11","y":530.1138962085076},{"name":"2014-10-18","y":527.9195772774242},{"name":"2014-10-25","y":627},{"name":"2014-11-01","y":646},{"name":"2014-11-08","y":650.240782683909},{"name":"2014-11-15","y":579},{"name":"2014-11-22","y":576.6033251152548},{"name":"2014-11-29","y":574.2165708704115},{"name":"2014-12-06","y":571.8396962006193},{"name":"2014-12-13","y":569.472660211009},{"name":"2014-12-20","y":567.1154221759889},{"name":"2014-12-27","y":564.7679415385435},{"name":"2015-01-03","y":562.4301779095372},{"name":"2015-01-10","y":560.1020910670181},{"name":"2015-01-17","y":557.7836409555266},{"name":"2015-01-24","y":555.474787685406},{"name":"2015-01-31","y":553.1754915321162},{"name":"2015-02-07","y":550.8857129355505},{"name":"2015-02-14","y":548.6054124993543},{"name":"2015-02-21","y":546.3345509902481},{"name":"2015-02-28","y":544.073089337352},{"name":"2015-03-07","y":541.8209886315135},{"name":"2015-03-14","y":539.5782101246378},{"name":"2015-03-21","y":537.3447152290223},{"name":"2015-03-28","y":535.1204655166907},{"name":"2015-04-04","y":532.9054227187339},{"name":"2015-04-11","y":530.6995487246502},{"name":"2015-04-18","y":528.5028055816899},{"name":"2015-04-25","y":526.3151554942029},{"name":"2015-05-02","y":563.0369907866988},{"name":"2015-05-09","y":513.010282623821},{"name":"2015-05-16","y":535.6318415517546},{"name":"2015-05-23","y":534.9695983730254},{"name":"2015-05-30","y":564.9555871744991},{"name":"2015-06-06","y":626.9457733078766},{"name":"2015-06-13","y":643.9401393989958},{"name":"2015-06-20","y":605},{"name":"2015-06-27","y":704},{"name":"2015-07-04","y":747},{"name":"2015-07-11","y":757.7871748856126},{"name":"2015-07-18","y":622.5793700605019},{"name":"2015-07-25","y":785},{"name":"2015-08-01","y":774},{"name":"2015-08-08","y":779.9154942663156},{"name":"2015-08-15","y":776.6871628719604},{"name":"2015-08-22","y":785.257170170944},{"name":"2015-08-29","y":800.8202895645037},{"name":"2015-09-05","y":797.5054262222004},{"name":"2015-09-12","y":794.2042842092907},{"name":"2015-09-19","y":787.0933412168374},{"name":"2015-09-26","y":787.1500782731553},{"name":"2015-10-03","y":824},{"name":"2015-10-10","y":887},{"name":"2015-10-17","y":704},{"name":"2015-10-24","y":776},{"name":"2015-10-31","y":872},{"name":"2015-11-07","y":872},{"name":"2015-11-14","y":868.3905000008674},{"name":"2015-11-21","y":864.7959409309135},{"name":"2015-11-28","y":861.2162609446291},{"name":"2015-12-05","y":857.6513984525045},{"name":"2015-12-12","y":854.1012921199697},{"name":"2015-12-19","y":810.5311240601457},{"name":"2015-12-26","y":807.1760643220814},{"name":"2016-01-02","y":803.8348922997529},{"name":"2016-01-09","y":811.4491182041503},{"name":"2016-01-16","y":762},{"name":"2016-01-23","y":777.2549197249497},{"name":"2016-01-30","y":785.5246777528885},{"name":"2016-02-06","y":782.2731280697833},{"name":"2016-02-13","y":779.035037639635},{"name":"2016-02-20","y":818.1215131416525},{"name":"2016-02-27","y":810.1032501746671},{"name":"2016-03-05","y":780.9338113202509},{"name":"2016-03-12","y":777.7012647706144},{"name":"2016-03-19","y":721.6218365416906},{"name":"2016-03-26","y":718.6348021169529},{"name":"2016-04-02","y":715.6601320279417},{"name":"2016-04-09","y":712.697775094531},{"name":"2016-04-16","y":678.3281903789134},{"name":"2016-04-23","y":675.5203628530139},{"name":"2016-04-30","y":672.7241578654773},{"name":"2016-05-07","y":699.8934616768496},{"name":"2016-05-14","y":696.9963682716713},{"name":"2016-05-21","y":694.1112669062217},{"name":"2016-05-28","y":759.8269850033705},{"name":"2016-06-04","y":723.1455779820969},{"name":"2016-06-11","y":753.8534042433948},{"name":"2016-06-18","y":695.7115546305768},{"name":"2016-06-25","y":692.8317715390222},{"name":"2016-07-02","y":689.9639088340116},{"name":"2016-07-09","y":662.4946851062006},{"name":"2016-07-16","y":659.7523977606545},{"name":"2016-07-23","y":664.0728139567216},{"name":"2016-07-30","y":550.3649627297507},{"name":"2016-08-06","y":548.0868178530355},{"name":"2016-08-13","y":545.8181029808278},{"name":"2016-08-20","y":543.5587790791811},{"name":"2016-08-27","y":541.3088072757238},{"name":"2016-09-03","y":569.7774115399486},{"name":"2016-09-10","y":567.4189120371284},{"name":"2016-09-17","y":565.0701751535208},{"name":"2016-09-24","y":543.9942616792163},{"name":"2016-10-01","y":541.742487267451},{"name":"2016-10-08","y":539.5000337040084},{"name":"2016-10-15","y":537.2668624067759},{"name":"2016-10-22","y":515.7086155160684},{"name":"2016-10-29","y":483.3951420010626},{"name":"2016-11-05","y":481.39420763795073},{"name":"2016-11-12","y":470.8685238075409},{"name":"2016-11-19","y":468.91944131181276},{"name":"2016-11-26","y":466.97842672120703},{"name":"2016-12-03","y":465.0454466399626},{"name":"2016-12-10","y":463.1204678105548},{"name":"2016-12-17","y":461.203457113123},{"name":"2016-12-24","y":459.29438156490085},{"name":"2016-12-31","y":457.39320831964835},{"name":"2017-01-07","y":455.49990466708755},{"name":"2017-01-14","y":463.99749943098834},{"name":"2017-01-21","y":451.3501244267617},{"name":"2017-01-28","y":449.481835122029},{"name":"2017-02-04","y":447.62127929234657},{"name":"2017-02-11","y":445.76842492627145},{"name":"2017-02-18","y":443.92324014486695},{"name":"2017-02-25","y":442.08569320115384},{"name":"2017-03-04","y":443.35288437273095},{"name":"2017-03-11","y":469.6420017810603},{"name":"2017-03-18","y":503.44307654576494},{"name":"2017-03-25","y":511.8073148903005},{"name":"2017-04-01","y":517.1334008960857},{"name":"2017-04-08","y":533.4622764575607},{"name":"2017-04-15","y":538.7939300278205},{"name":"2017-04-22","y":640.1283501077562},{"name":"2017-04-29","y":648},{"name":"2017-05-06","y":645.3177110098189},{"name":"2017-05-13","y":642.6465249119632},{"name":"2017-05-20","y":639.9863957478436},{"name":"2017-05-27","y":637.3372777491088},{"name":"2017-06-03","y":634.6991253368582},{"name":"2017-06-10","y":682.6984279261574},{"name":"2017-06-17","y":646},{"name":"2017-06-24","y":674.110043004801},{"name":"2017-07-01","y":672.0275020646754},{"name":"2017-07-08","y":703.3411652558432},{"name":"2017-07-15","y":738.1376269123464},{"name":"2017-07-22","y":707.9432097519332},{"name":"2017-07-29","y":760.7152114521363},{"name":"2017-08-05","y":738.8471299664085},{"name":"2017-08-12","y":783.9826417606371},{"name":"2017-08-19","y":693.5570633834276},{"name":"2017-08-26","y":641.4218126972255},{"name":"2017-09-02","y":638.7667530270716},{"name":"2017-09-09","y":636.1226835379694},{"name":"2017-09-16","y":633.4895587378793},{"name":"2017-09-23","y":630.8673333230686},{"name":"2017-09-30","y":628.2559621773319},{"name":"2017-10-07","y":625.6554003712147},{"name":"2017-10-14","y":623.0656031612409},{"name":"2017-10-21","y":620.4865259891421}]}` {
		t.Fatal(string(body))
	}
}
