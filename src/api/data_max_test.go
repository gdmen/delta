package api

import (
	_ "github.com/mattn/go-sqlite3"
	"io/ioutil"
	"net/http"
	"net/http/httptest"
	"strings"
	"testing"
)

func TestGetMaxesBasic(t *testing.T) {
	ResetTestApi()
	PopulateTestApi()
	r := TestApi.GetRouter()

	resp := httptest.NewRecorder()

	req, _ := http.NewRequest("GET", `/api/v1/data/maxes?fields=[{"name":"Flat Barbell Bench Press"},{"name":"Barbell Back Squat"},{"name":"Conventional Barbell Deadlift"}]&increment=2`, nil)

	r.ServeHTTP(resp, req)

	if resp.Code != http.StatusOK {
		t.Fatalf("Expected status code %d, got %d. . .\n%+v", http.StatusOK, resp.Code, resp)
	}

	body, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		t.Fatal(err)
	}
	if strings.TrimSpace(string(body)) != `{"data":[{"name":"2014-08-09","y":314},{"name":"2014-08-16","y":548},{"name":"2014-08-23","y":545.7316444959579},{"name":"2014-08-30","y":543.4726784749317},{"name":"2014-09-06","y":541.2230630707072},{"name":"2014-09-13","y":538.98275957795},{"name":"2014-09-20","y":536.7517294515404},{"name":"2014-09-27","y":534.5299343059099},{"name":"2014-10-04","y":532.3173359143807},{"name":"2014-10-11","y":530.1138962085076},{"name":"2014-10-18","y":527.9195772774242},{"name":"2014-10-25","y":627},{"name":"2014-11-01","y":646},{"name":"2014-11-08","y":650.240782683909},{"name":"2014-11-15","y":680.6533696923611},{"name":"2014-11-22","y":677.8359174706704},{"name":"2014-11-29","y":675.0301276271814},{"name":"2014-12-06","y":672.2359518874052},{"name":"2014-12-13","y":669.4533421766776},{"name":"2014-12-20","y":666.6822506193312},{"name":"2014-12-27","y":663.9226295378721},{"name":"2015-01-03","y":661.17443145216},{"name":"2015-01-10","y":658.43760907859},{"name":"2015-01-17","y":655.7121153292802},{"name":"2015-01-24","y":652.9979033112616},{"name":"2015-01-31","y":650.2949263256703},{"name":"2015-02-07","y":647.603137866945},{"name":"2015-02-14","y":644.9224916220263},{"name":"2015-02-21","y":642.2529414695604},{"name":"2015-02-28","y":639.5944414791047},{"name":"2015-03-07","y":636.9469459103386},{"name":"2015-03-14","y":634.3104092122757},{"name":"2015-03-21","y":631.6847860224804},{"name":"2015-03-28","y":629.0700311662874},{"name":"2015-04-04","y":626.4660996560248},{"name":"2015-04-11","y":623.8729466902391},{"name":"2015-04-18","y":621.2905276529258},{"name":"2015-04-25","y":618.7187981127603},{"name":"2015-05-02","y":616.1577138223345},{"name":"2015-05-09","y":613.6072307173949},{"name":"2015-05-16","y":611.067304916085},{"name":"2015-05-23","y":608.5378927181899},{"name":"2015-05-30","y":621.883480320617},{"name":"2015-06-06","y":648.2779007083684},{"name":"2015-06-13","y":652.6789671277813},{"name":"2015-06-20","y":665.9386681456119},{"name":"2015-06-27","y":704},{"name":"2015-07-04","y":747},{"name":"2015-07-11","y":757.7871748856126},{"name":"2015-07-18","y":761.349987606669},{"name":"2015-07-25","y":785},{"name":"2015-08-01","y":813.7457815369987},{"name":"2015-08-08","y":819.4967547042049},{"name":"2015-08-15","y":816.1045832186613},{"name":"2015-08-22","y":812.7264530668037},{"name":"2015-08-29","y":822.4680416387573},{"name":"2015-09-05","y":819.0635710016223},{"name":"2015-09-12","y":815.6731926084802},{"name":"2015-09-19","y":812.2968481268142},{"name":"2015-09-26","y":815.2860454947819},{"name":"2015-10-03","y":831.2218050460585},{"name":"2015-10-10","y":887},{"name":"2015-10-17","y":883.3284099779464},{"name":"2015-10-24","y":885.704001472563},{"name":"2015-10-31","y":890.4684461012855},{"name":"2015-11-07","y":913.654716170048},{"name":"2015-11-14","y":909.8727933521313},{"name":"2015-11-21","y":906.1065251791781},{"name":"2015-11-28","y":902.3558468513704},{"name":"2015-12-05","y":898.620693837119},{"name":"2015-12-12","y":894.9010018719518},{"name":"2015-12-19","y":891.19670695741},{"name":"2015-12-26","y":887.5077453599447},{"name":"2016-01-02","y":883.8340536098221},{"name":"2016-01-09","y":880.1755685000307},{"name":"2016-01-16","y":876.5322270851943},{"name":"2016-01-23","y":872.9039666804881},{"name":"2016-01-30","y":869.2907248605616},{"name":"2016-02-06","y":865.6924394584628},{"name":"2016-02-13","y":862.1090485645701},{"name":"2016-02-20","y":858.5404905255266},{"name":"2016-02-27","y":860.9576198264849},{"name":"2016-03-05","y":857.3938279365573},{"name":"2016-03-12","y":853.8447877746382},{"name":"2016-03-19","y":850.3104382783861},{"name":"2016-03-26","y":846.7907186382159},{"name":"2016-04-02","y":843.2855682962547},{"name":"2016-04-09","y":839.7949269452985},{"name":"2016-04-16","y":836.318734527775},{"name":"2016-04-23","y":832.8569312347099},{"name":"2016-04-30","y":829.4094575046993},{"name":"2016-05-07","y":825.976254022883},{"name":"2016-05-14","y":822.5572617199252},{"name":"2016-05-21","y":819.152421770998},{"name":"2016-05-28","y":815.7616755947688},{"name":"2016-06-04","y":812.3849648523928},{"name":"2016-06-11","y":819.1832235054653},{"name":"2016-06-18","y":817.5871021239298},{"name":"2016-06-25","y":814.2028353298849},{"name":"2016-07-02","y":810.8325771493608},{"name":"2016-07-09","y":807.4762695960152},{"name":"2016-07-16","y":804.1338549235307},{"name":"2016-07-23","y":800.8052756246213},{"name":"2016-07-30","y":797.4904744300429},{"name":"2016-08-06","y":794.1893943076076},{"name":"2016-08-13","y":790.9019784612035},{"name":"2016-08-20","y":787.6281703298162},{"name":"2016-08-27","y":784.3679135865566},{"name":"2016-09-03","y":781.1211521376916},{"name":"2016-09-10","y":777.8878301216785},{"name":"2016-09-17","y":774.6678919082043},{"name":"2016-09-24","y":771.4612820972286},{"name":"2016-10-01","y":768.2679455180305},{"name":"2016-10-08","y":765.0878272282587},{"name":"2016-10-15","y":761.9208725129872},{"name":"2016-10-22","y":758.767026883773},{"name":"2016-10-29","y":755.6262360777192},{"name":"2016-11-05","y":752.4984460565413},{"name":"2016-11-12","y":749.3836030056373},{"name":"2016-11-19","y":746.2816533331616},{"name":"2016-11-26","y":743.1925436691033},{"name":"2016-12-03","y":740.1162208643682},{"name":"2016-12-10","y":737.0526319898638},{"name":"2016-12-17","y":734.0017243355884},{"name":"2016-12-24","y":730.9634454097253},{"name":"2016-12-31","y":727.9377429377386},{"name":"2017-01-07","y":724.9245648614744},{"name":"2017-01-14","y":721.923859338265},{"name":"2017-01-21","y":718.9355747400364},{"name":"2017-01-28","y":715.959659652421},{"name":"2017-02-04","y":712.9960628738725},{"name":"2017-02-11","y":710.0447334147843},{"name":"2017-02-18","y":707.1056204966137},{"name":"2017-02-25","y":704.1786735510068},{"name":"2017-03-04","y":701.2638422189294},{"name":"2017-03-11","y":698.3610763497999},{"name":"2017-03-18","y":695.4703260006269},{"name":"2017-03-25","y":692.5915414351498},{"name":"2017-04-01","y":689.7246731229831},{"name":"2017-04-08","y":686.8696717387638},{"name":"2017-04-15","y":685.5548701866838},{"name":"2017-04-22","y":717.302371671338},{"name":"2017-04-29","y":726.0327645496957},{"name":"2017-05-06","y":723.0274718168833},{"name":"2017-05-13","y":720.0346189970487},{"name":"2017-05-20","y":717.054154597226},{"name":"2017-05-27","y":714.0860273375968},{"name":"2017-06-03","y":711.1301861506062},{"name":"2017-06-10","y":742.5112523617717},{"name":"2017-06-17","y":739.4377496498957},{"name":"2017-06-24","y":736.3769691949417},{"name":"2017-07-01","y":733.3288583352279},{"name":"2017-07-08","y":735.5589064793492},{"name":"2017-07-15","y":752.4551817553429},{"name":"2017-07-22","y":749.340517789869},{"name":"2017-07-29","y":774.9144813056674},{"name":"2017-08-05","y":771.7068507786025},{"name":"2017-08-12","y":806.3462044293831},{"name":"2017-08-19","y":803.0084674750385},{"name":"2017-08-26","y":799.6845465316272},{"name":"2017-09-02","y":796.3743844100536},{"name":"2017-09-09","y":793.0779241579467},{"name":"2017-09-16","y":789.7951090586803},{"name":"2017-09-23","y":786.525882630398},{"name":"2017-09-30","y":783.2701886250399},{"name":"2017-10-07","y":780.0279710273762},{"name":"2017-10-14","y":776.7991740540429},{"name":"2017-10-21","y":773.5837421525815}]}` {
		t.Fatal(string(body))
	}
}
