package api

import (
	_ "github.com/mattn/go-sqlite3"
	"io/ioutil"
	"net/http"
	"net/http/httptest"
	"strings"
	"testing"
)

func TestGetMaxesBasic(t *testing.T) {
	ResetTestApi()
	PopulateTestApi()
	r := TestApi.GetRouter()

	resp := httptest.NewRecorder()

	req, _ := http.NewRequest("GET", `/api/v1/data/maxes?fields=[{"name":"Flat Barbell Bench Press"},{"name":"Barbell Back Squat"},{"name":"Conventional Barbell Deadlift"}]&increment=2`, nil)

	r.ServeHTTP(resp, req)

	if resp.Code != http.StatusOK {
		t.Fatalf("Expected status code %d, got %d. . .\n%+v", http.StatusOK, resp.Code, resp)
	}

	body, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		t.Fatal(err)
	}
	if strings.TrimSpace(string(body)) != `{"data":[{"name":"2014-08-09","y":314},{"name":"2014-08-16","y":548},{"name":"2014-08-23","y":546.2013800275392},{"name":"2014-08-30","y":544.4086634014386},{"name":"2014-09-06","y":542.6218307460108},{"name":"2014-09-13","y":540.8408627491624},{"name":"2014-09-20","y":539.0657401621851},{"name":"2014-09-27","y":537.2964437995482},{"name":"2014-10-04","y":535.5329545386905},{"name":"2014-10-11","y":533.7752533198144},{"name":"2014-10-18","y":532.0233211456788},{"name":"2014-10-25","y":627},{"name":"2014-11-01","y":646},{"name":"2014-11-08","y":650.6050848753728},{"name":"2014-11-15","y":579},{"name":"2014-11-22","y":577.0996332772725},{"name":"2014-11-29","y":575.2055038493304},{"name":"2014-12-06","y":573.3175912444167},{"name":"2014-12-13","y":571.4358750579654},{"name":"2014-12-20","y":569.5603349523819},{"name":"2014-12-27","y":567.690950656822},{"name":"2015-01-03","y":565.8277019669742},{"name":"2015-01-10","y":563.9705687448404},{"name":"2015-01-17","y":562.1195309185183},{"name":"2015-01-24","y":560.2745684819849},{"name":"2015-01-31","y":558.43566149488},{"name":"2015-02-07","y":556.6027900822905},{"name":"2015-02-14","y":554.7759344345363},{"name":"2015-02-21","y":552.955074806955},{"name":"2015-02-28","y":551.1401915196899},{"name":"2015-03-07","y":549.3312649574762},{"name":"2015-03-14","y":547.5282755694294},{"name":"2015-03-21","y":545.7312038688342},{"name":"2015-03-28","y":543.9400304329337},{"name":"2015-04-04","y":542.1547359027192},{"name":"2015-04-11","y":540.3753009827213},{"name":"2015-04-18","y":538.6017064408016},{"name":"2015-04-25","y":536.8339331079443},{"name":"2015-05-02","y":568.2119474172459},{"name":"2015-05-09","y":518.3808670050373},{"name":"2015-05-16","y":541.2702491479317},{"name":"2015-05-23","y":540.7268804275704},{"name":"2015-05-30","y":570.9039563860198},{"name":"2015-06-06","y":633.0837333072736},{"name":"2015-06-13","y":650.2662023263584},{"name":"2015-06-20","y":605},{"name":"2015-06-27","y":704},{"name":"2015-07-04","y":747},{"name":"2015-07-11","y":758.0383291023157},{"name":"2015-07-18","y":623.0798145558788},{"name":"2015-07-25","y":785},{"name":"2015-08-01","y":774},{"name":"2015-08-08","y":780.1400758525826},{"name":"2015-08-15","y":777.5795365793247},{"name":"2015-08-22","y":785.8242267322585},{"name":"2015-08-29","y":801.0645863281911},{"name":"2015-09-05","y":798.4353696051967},{"name":"2015-09-12","y":795.8147823743739},{"name":"2015-09-19","y":788.9300915472645},{"name":"2015-09-26","y":788.3535327485818},{"name":"2015-10-03","y":824},{"name":"2015-10-10","y":887},{"name":"2015-10-17","y":704},{"name":"2015-10-24","y":776},{"name":"2015-10-31","y":872},{"name":"2015-11-07","y":872},{"name":"2015-11-14","y":869.1379623795881},{"name":"2015-11-21","y":866.285318405209},{"name":"2015-11-28","y":863.4420372454772},{"name":"2015-12-05","y":860.6080881702001},{"name":"2015-12-12","y":857.7834405500464},{"name":"2015-12-19","y":813.9135353023673},{"name":"2015-12-26","y":811.2421463599385},{"name":"2016-01-02","y":808.5795253253676},{"name":"2016-01-09","y":816.4664692839503},{"name":"2016-01-16","y":762},{"name":"2016-01-23","y":777.4092124178048},{"name":"2016-01-30","y":786.0372723658185},{"name":"2016-02-06","y":783.4573775899504},{"name":"2016-02-13","y":780.8859504240654},{"name":"2016-02-20","y":819.7457622727383},{"name":"2016-02-27","y":811.5220596614857},{"name":"2016-03-05","y":782.7972157336101},{"name":"2016-03-12","y":780.2279553200972},{"name":"2016-03-19","y":724.3644929031564},{"name":"2016-03-26","y":721.9870176398772},{"name":"2016-04-02","y":719.6173456147231},{"name":"2016-04-09","y":717.255451216271},{"name":"2016-04-16","y":682.3375750940838},{"name":"2016-04-23","y":680.0980386150243},{"name":"2016-04-30","y":677.8658526378632},{"name":"2016-05-07","y":705.1916330775105},{"name":"2016-05-14","y":702.877086078121},{"name":"2016-05-21","y":700.5701357766519},{"name":"2016-05-28","y":764.6937556130022},{"name":"2016-06-04","y":723.529595350981},{"name":"2016-06-11","y":754.0908435540664},{"name":"2016-06-18","y":696.1846710989024},{"name":"2016-06-25","y":693.8996863289034},{"name":"2016-07-02","y":691.6222012290577},{"name":"2016-07-09","y":664.2463274361601},{"name":"2016-07-16","y":662.0661692041157},{"name":"2016-07-23","y":665.6982270204696},{"name":"2016-07-30","y":550.7035494724051},{"name":"2016-08-06","y":548.8960560362991},{"name":"2016-08-13","y":547.0944950706207},{"name":"2016-08-20","y":545.2988471040928},{"name":"2016-08-27","y":543.509092729346},{"name":"2016-09-03","y":570.4403671632538},{"name":"2016-09-10","y":568.5680944671267},{"name":"2016-09-17","y":566.7019668568848},{"name":"2016-09-24","y":545.6379586405682},{"name":"2016-10-01","y":543.8470912497952},{"name":"2016-10-08","y":542.0621017602211},{"name":"2016-10-15","y":540.2829708796738},{"name":"2016-10-22","y":518.6260666687817},{"name":"2016-10-29","y":484.95188690422765},{"name":"2016-11-05","y":483.3602005000881},{"name":"2016-11-12","y":471.309188243743},{"name":"2016-11-19","y":469.7622792671382},{"name":"2016-11-26","y":468.22044748283435},{"name":"2016-12-03","y":466.68367622670814},{"name":"2016-12-10","y":465.1519488893309},{"name":"2016-12-17","y":463.62524891578823},{"name":"2016-12-24","y":462.10355980550173},{"name":"2016-12-31","y":460.58686511205036},{"name":"2017-01-07","y":459.0751484429927},{"name":"2017-01-14","y":465.4238322188189},{"name":"2017-01-21","y":451.48470194219647},{"name":"2017-01-28","y":450.00285996742696},{"name":"2017-02-04","y":448.5258816250878},{"name":"2017-02-11","y":447.05375095199213},{"name":"2017-02-18","y":445.5864520373467},{"name":"2017-02-25","y":444.12396902257973},{"name":"2017-03-04","y":445.12732274579946},{"name":"2017-03-11","y":470.7416846724611},{"name":"2017-03-18","y":504.7874259117334},{"name":"2017-03-25","y":513.0728855358025},{"name":"2017-04-01","y":518.5343731838609},{"name":"2017-04-08","y":534.997628311977},{"name":"2017-04-15","y":540.4626451190105},{"name":"2017-04-22","y":641.9294178228612},{"name":"2017-04-29","y":648},{"name":"2017-05-06","y":645.8731647040976},{"name":"2017-05-13","y":643.7533100075407},{"name":"2017-05-20","y":641.6404129989326},{"name":"2017-05-27","y":639.5344508420752},{"name":"2017-06-03","y":637.4354007757225},{"name":"2017-06-10","y":683.5818935491259},{"name":"2017-06-17","y":646},{"name":"2017-06-24","y":674.2943370546003},{"name":"2017-07-01","y":672.6424479183726},{"name":"2017-07-08","y":703.8899518437815},{"name":"2017-07-15","y":739.1409253647491},{"name":"2017-07-22","y":709.3976394586317},{"name":"2017-07-29","y":761.8006120746403},{"name":"2017-08-05","y":740.1087321639023},{"name":"2017-08-12","y":785.4191231090513},{"name":"2017-08-19","y":695.4911235341804},{"name":"2017-08-26","y":642.1617273152794},{"name":"2017-09-02","y":640.0540541249525},{"name":"2017-09-09","y":637.9532986410045},{"name":"2017-09-16","y":635.8594381584626},{"name":"2017-09-23","y":633.772450046876},{"name":"2017-09-30","y":631.6923117500701},{"name":"2017-10-07","y":629.619000785903},{"name":"2017-10-14","y":627.552494746023},{"name":"2017-10-21","y":625.4927712956256},{"name":"2017-10-28","y":623.4398081732129},{"name":"2017-11-04","y":621.3935831903527},{"name":"2017-11-11","y":619.3540742314384}]}` {
		t.Fatal("ERROR: " + string(body))
	}
}
