package api

import (
	"github.com/gdmen/delta/src/common"
	_ "github.com/go-sql-driver/mysql"
	"io/ioutil"
	"net/http"
	"net/http/httptest"
	"strings"
	"testing"
)

func TestGetMaxesBasic(t *testing.T) {
	c, err := common.ReadConfig("../../test_conf.json")
	if err != nil {
		t.Fatalf("Couldn't read config: %v", err)
	}
	ResetTestApi(c)
	InsertTestMeasurementTypes(c)
	InsertTestMeasurements(c)
	r := TestApi.GetRouter()

	resp := httptest.NewRecorder()

	req, _ := http.NewRequest("GET", `/api/v1/data/maxes?fields=[{"name":"Flat Barbell Bench Press"},{"name":"Barbell Back Squat"},{"name":"Conventional Barbell Deadlift"}]&increment=2`, nil)

	r.ServeHTTP(resp, req)

	if resp.Code != http.StatusOK {
		t.Fatalf("Expected status code %d, got %d. . .\n%+v", http.StatusOK, resp.Code, resp)
	}

	body, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		t.Fatal(err)
	}
	if strings.TrimSpace(string(body)) != `{"data":[{"name":"2014-08-09","y":314},{"name":"2014-08-16","y":518},{"name":"2014-08-23","y":534.2943370546003},{"name":"2014-08-30","y":532.5407011681057},{"name":"2014-09-06","y":530.7928209833078},{"name":"2014-09-13","y":529.050677609112},{"name":"2014-09-20","y":527.3142522164266},{"name":"2014-09-27","y":525.58352603796},{"name":"2014-10-04","y":523.858480368018},{"name":"2014-10-11","y":522.1390965623012},{"name":"2014-10-18","y":520.4253560377035},{"name":"2014-10-25","y":627},{"name":"2014-11-01","y":633.4847019421965},{"name":"2014-11-08","y":651.1400758525826},{"name":"2014-11-15","y":579},{"name":"2014-11-22","y":577.0996332772725},{"name":"2014-11-29","y":575.2055038493304},{"name":"2014-12-06","y":573.3175912444167},{"name":"2014-12-13","y":571.4358750579654},{"name":"2014-12-20","y":569.5603349523819},{"name":"2014-12-27","y":567.690950656822},{"name":"2015-01-03","y":565.8277019669742},{"name":"2015-01-10","y":563.9705687448404},{"name":"2015-01-17","y":562.1195309185183},{"name":"2015-01-24","y":560.2745684819849},{"name":"2015-01-31","y":558.43566149488},{"name":"2015-02-07","y":556.6027900822905},{"name":"2015-02-14","y":554.7759344345363},{"name":"2015-02-21","y":552.955074806955},{"name":"2015-02-28","y":551.1401915196899},{"name":"2015-03-07","y":549.3312649574762},{"name":"2015-03-14","y":547.5282755694294},{"name":"2015-03-21","y":545.7312038688342},{"name":"2015-03-28","y":543.9400304329337},{"name":"2015-04-04","y":542.1547359027192},{"name":"2015-04-11","y":540.3753009827213},{"name":"2015-04-18","y":538.6017064408016},{"name":"2015-04-25","y":536.8339331079443},{"name":"2015-05-02","y":568.2119474172459},{"name":"2015-05-09","y":518.3808670050373},{"name":"2015-05-16","y":541.2702491479317},{"name":"2015-05-23","y":527.7268804275704},{"name":"2015-05-30","y":570.9039563860198},{"name":"2015-06-06","y":633.0837333072736},{"name":"2015-06-13","y":650.2662023263584},{"name":"2015-06-20","y":605},{"name":"2015-06-27","y":704},{"name":"2015-07-04","y":747},{"name":"2015-07-11","y":758.0383291023157},{"name":"2015-07-18","y":623.0798145558788},{"name":"2015-07-25","y":785},{"name":"2015-08-01","y":774},{"name":"2015-08-08","y":780.1400758525826},{"name":"2015-08-15","y":777.5795365793247},{"name":"2015-08-22","y":785.8242267322585},{"name":"2015-08-29","y":801.0645863281911},{"name":"2015-09-05","y":798.4353696051967},{"name":"2015-09-12","y":795.8147823743739},{"name":"2015-09-19","y":788.9300915472645},{"name":"2015-09-26","y":769.7955666987307},{"name":"2015-10-03","y":832},{"name":"2015-10-10","y":870},{"name":"2015-10-17","y":721},{"name":"2015-10-24","y":781.3534158128198},{"name":"2015-10-31","y":866},{"name":"2015-11-07","y":872},{"name":"2015-11-14","y":865.8009573329405},{"name":"2015-11-21","y":862.9592659204685},{"name":"2015-11-28","y":860.1269013746573},{"name":"2015-12-05","y":857.303833083301},{"name":"2015-12-12","y":854.4900305346682},{"name":"2015-12-19","y":813.9135353023673},{"name":"2015-12-26","y":811.2421463599385},{"name":"2016-01-02","y":808.5795253253676},{"name":"2016-01-09","y":805.9256434210374},{"name":"2016-01-16","y":751},{"name":"2016-01-23","y":675.1400758525826},{"name":"2016-01-30","y":777.4092124178048},{"name":"2016-02-06","y":786.0372723658185},{"name":"2016-02-13","y":783.4573775899504},{"name":"2016-02-20","y":780.8859504240654},{"name":"2016-02-27","y":826.6104559921871},{"name":"2016-03-05","y":810.8820397807743},{"name":"2016-03-12","y":782.1592964962202},{"name":"2016-03-19","y":725.4422075191097},{"name":"2016-03-26","y":723.061195031318},{"name":"2016-04-02","y":720.6879973913642},{"name":"2016-04-09","y":718.3225889497205},{"name":"2016-04-16","y":715.9649441410442},{"name":"2016-04-23","y":681.676763036158},{"name":"2016-04-30","y":679.4393954435318},{"name":"2016-05-07","y":706.2448295965453},{"name":"2016-05-14","y":703.9268258447944},{"name":"2016-05-21","y":701.6164301365548},{"name":"2016-05-28","y":773.9111788649218},{"name":"2016-06-04","y":724.1072543202384},{"name":"2016-06-11","y":754.0908435540664},{"name":"2016-06-18","y":696.1846710989024},{"name":"2016-06-25","y":693.8996863289034},{"name":"2016-07-02","y":691.6222012290577},{"name":"2016-07-09","y":664.2463274361601},{"name":"2016-07-16","y":662.0661692041157},{"name":"2016-07-23","y":650.6103403865989},{"name":"2016-07-30","y":551.2943370546003},{"name":"2016-08-06","y":549.4849045631205},{"name":"2016-08-13","y":547.6814109063451},{"name":"2016-08-20","y":545.8838365921087},{"name":"2016-08-27","y":544.0921621922217},{"name":"2016-09-03","y":564.5057562676211},{"name":"2016-09-10","y":569.1687285090251},{"name":"2016-09-17","y":567.3006295258199},{"name":"2016-09-24","y":545.6379586405682},{"name":"2016-10-01","y":543.8470912497952},{"name":"2016-10-08","y":542.0621017602211},{"name":"2016-10-15","y":540.2829708796738},{"name":"2016-10-22","y":518.6260666687817},{"name":"2016-10-29","y":472.95188690422765},{"name":"2016-11-05","y":483.87549855789166},{"name":"2016-11-12","y":471.82279501435943},{"name":"2016-11-19","y":470.27420030163125},{"name":"2016-11-26","y":468.7306883140482},{"name":"2016-12-03","y":467.1922423693275},{"name":"2016-12-10","y":465.65884583994034},{"name":"2016-12-17","y":464.1304821529318},{"name":"2016-12-24","y":462.60713478974185},{"name":"2016-12-31","y":461.0887872860271},{"name":"2017-01-07","y":459.5754232314828},{"name":"2017-01-14","y":465.92246502879385},{"name":"2017-01-21","y":451.48470194219647},{"name":"2017-01-28","y":450.00285996742696},{"name":"2017-02-04","y":448.5258816250878},{"name":"2017-02-11","y":447.05375095199213},{"name":"2017-02-18","y":445.5864520373467},{"name":"2017-02-25","y":444.12396902257973},{"name":"2017-03-04","y":445.12732274579946},{"name":"2017-03-11","y":443.6663466637218},{"name":"2017-03-18","y":504.7874259117334},{"name":"2017-03-25","y":503.1306362290841},{"name":"2017-04-01","y":518.5343731838609},{"name":"2017-04-08","y":534.997628311977},{"name":"2017-04-15","y":540.4626451190105},{"name":"2017-04-22","y":545.9294178228612},{"name":"2017-04-29","y":666},{"name":"2017-05-06","y":663.8140859458781},{"name":"2017-05-13","y":661.6353463966391},{"name":"2017-05-20","y":659.4637578044585},{"name":"2017-05-27","y":657.2992966987995},{"name":"2017-06-03","y":655.1419396861593},{"name":"2017-06-10","y":652.9916634498159},{"name":"2017-06-17","y":727},{"name":"2017-06-24","y":674.2943370546003},{"name":"2017-07-01","y":672.6424479183726},{"name":"2017-07-08","y":670.9959805354163},{"name":"2017-07-15","y":740.1912143997627},{"name":"2017-07-22","y":704.4444812840919},{"name":"2017-07-29","y":736.7034812141666},{"name":"2017-08-05","y":745.1087321639023},{"name":"2017-08-12","y":745.4191231090513},{"name":"2017-08-19","y":696.73177745679},{"name":"2017-08-26","y":643.3983092216043},{"name":"2017-09-02","y":641.286577379974},{"name":"2017-09-09","y":639.1817765658379},{"name":"2017-09-16","y":654.5209371282976},{"name":"2017-09-23","y":652.3726991175081},{"name":"2017-09-30","y":596.4403671632538},{"name":"2017-10-07","y":513.3426826304492},{"name":"2017-10-14","y":784},{"name":"2017-10-21","y":832.1006900137697},{"name":"2017-10-28","y":820.2043317007194},{"name":"2017-11-04","y":817.5122954005448},{"name":"2017-11-11","y":850.0087308850364},{"name":"2017-11-18","y":874},{"name":"2017-11-25","y":918.3501336595854}]}` {
		t.Fatal("ERROR: " + string(body))
	}
}
